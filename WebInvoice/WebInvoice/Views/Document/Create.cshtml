@using WebInvoice.Dto.Document
@model VatDocumentDto
@inject WebInvoice.Services.IUserCompanyTemp userCompanyData
<form asp-controller="Document" asp-action="Create" id="form1" autocomplete="off">
    <h1 class="text-center">@userCompanyData.CompanyName </h1>
    <h2 class="text-center">Фактура: 0000000001</h2>

    <div class="card">
        <div class="card-header d-inline-flex justify-content-between">
            <div class="form-inline align-items-center">
                <label for="findPartner" class="m-1">Получател: </label>
                <input type="text" id="findPartner" class="form-control" list="partnersDataList" oninput="findPartnerAjax()" onkeydown="loadPartner(event)" placeholder="Търси..." />
                <datalist id="partnersDataList"></datalist>
            </div>
            <h3 class="align-content-center" id="partnerHead"></h3>
            <button id="partnerDescription" class="btn btn-outline-primary align-content-end" type="button" data-toggle="collapse" data-target="#description" aria-expanded="false" aria-controls="description">
                Подробности
            </button>
        </div>

        <div class="collapse" id="description">
            <div class="card-body">
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <th>Получател</th>
                            <td id="partner"></td>
                        </tr>
                        <tr>
                            <th>ЕИК</th>
                            <td id="eik"></td>
                        </tr>
                        <tr>
                            <th>Регистрация по ДДС</th>
                            <td id="isVatRegister"> </td>
                        </tr>
                        <tr>
                            <th>ДДС</th>
                            <td id="vat"></td>
                        </tr>
                        <tr>
                            <th>Адрес</th>
                            <td id="address"></td>
                        </tr>
                        <tr>
                            <th>МОЛ</th>
                            <td id="mol"></td>
                        </tr>
                        <tr>
                            <th>E-mail</th>
                            <td id="email"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="card text-center">

        <div class="card-body p-1">
            <div class="d-flex justify-content-center invisible" id="loading">
                <div class="spinner-border" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div class="col-12 m-0 d-flex flex-row">
                <div class="m-0 px-1 text-center" style="width:25px">№</div><div class="m-0 px-1 text-center" style="width:25px">П</div><div class="col-6 m-0 p-0">Наимование на стоката</div><div class="col m-0 p-0">Мярка</div><div class="col m-0 p-0">Количество</div><div class="col m-0 p-0">Цена</div><div class="col m-0 p-0">Сума</div><div class="m-0 px-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                        <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                    </svg>
                </div>
            </div>
            <div id="productContainer">
                @if (Model.Sales != null)
                {
                    for (int i = 0; i < Model.Sales.Count; i++)
                    {
                        var readOnly = false;
                        if (Model.Sales[i].ProductId != 0)
                        {
                            readOnly = true;
                        }
                        <div class="col-12 m-0 d-flex flex-row productRow" id="row@(i)"><input type="hidden" asp-for="@Model.Sales[i].ProductId" class="productId"><input type="hidden" asp-for="@Model.Sales[i].FreePeoductID" class="freeProductId"><span class="m-0 px-1 text-right productCount" style="width: 25px;">@(i+1)</span><input asp-for="@Model.Sales[i].IsProduct" onchange="changeIsProduct(this)" type="checkbox" class="m-auto px-1 text-right isProduct" style="width: 25px;"><input asp-for="@Model.Sales[i].Name" oninput="findProductAjax(this)" onkeydown="loadProduct(event, this)" list="productDataList" class="col-6 m-0 p-0 productName" type="text"><input asp-for="@Model.Sales[i].ProductType" readonly="@readOnly" class="col m-0 p-0 productType" type="text"><input asp-for="@Model.Sales[i].Quantity" onkeydown="calculatePrice(event, this)" placeholder="@Model.Sales[i].AvailableQuantity" class="col m-0 p-0 productQuantity" type="text"><input asp-for="@Model.Sales[i].Price" readonly="@readOnly" class="col m-0 p-0 productPrice" onkeydown="calculatePrice(event, this)" type="text"><input asp-for="@Model.Sales[i].TottalPrice" onkeydown="newLine(event, this)" class="col m-0 p-0 productTottalPrice" type="text"><span class="m-0 px-1 close productDelete" onclick="delete_row(this)">X</span></div>
                    }
                }
            </div>
            <datalist id="productDataList"></datalist>
            <div class="d-flex flex-row justify-content-end">
                <div class="btn btn-light btn-sm" onclick="addProductElement()">Нов ред</div>
            </div>
            <input asp-for="PartnerId" type="hidden" id="partnerId" />
            <button type="submit">субмит</button>
            @*<div  class="" data-toggle="tooltip" data-placement="top" title="Tooltip on topasaaaaasssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss">
                Tooltip on top
                asas
            </div>*@
        </div>
        <div class="card-footer text-muted">
            <input asp-for="@Model.CreatedDate" type="date" />
            2 days ago
        </div>
    </div>
</form>
@section Styles {
    <link rel="stylesheet" href="~/css/document.css" />
}
@section Scripts{
    <script type="text/javascript">
        
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
        var vatTypes = JSON.parse('@Html.Raw(Model.VatTypes)');
        console.log(vatTypes);
        document.getElementById('findPartner').focus();
        var partnerDataListValues = [];
        var loadedPartner = document.getElementById('partnerId').value;

        preventEnter();

        var productContainer = document.getElementById('productContainer');

        if (loadedPartner != "") {
                loadPartnerById(loadedPartner);
        }

        function delete_row(e) {
            e.parentNode.parentNode.removeChild(e.parentNode);
            setIdAndName();
        }

        function newLine(event, element) {
            if (event.keyCode == 9) {

                if ((productContainer.childElementCount -1) == getIndex(element.id)) {

                    event.preventDefault();
                    addProductElement();
                }
            }
        }

        function getIndex(str) {
            const regex = /\d+/;
            let result = str.match(regex);
            return result[0];
        }

        function setIdAndName() {

            for (var i = 0; i < productContainer.childElementCount; i++) {

                var items = productContainer.children[i].children;
                items[0].id = `Sales_${i}__ProductId`;
                items[0].name = `Sales[${i}].ProductId`;
                items[1].id = `Sales_${i}__FreeProductId`;
                items[1].name = `Sales[${i}].FreeProductId`;
                items[2].innerHTML = i + 1;
                items[3].id = `Sales_${i}__IsProduct`;
                items[3].name = `Sales[${i}].IsProduct`;
                items[4].id = `Sales_${i}__Name`;
                items[4].name = `Sales[${i}].Name`;
                items[5].id = `Sales_${i}__ProductType`;
                items[5].name = `Sales[${i}].ProductType`;
                items[6].id = `Sales_${i}__Quantity`;
                items[6].name = `Sales[${i}].Quantity`;
                items[7].id = `Sales_${i}__Price`;
                items[7].name = `Sales[${i}].Price`;
                items[8].id = `Sales_${i}__TottalPrice`;
                items[8].name = `Sales[${i}].TottalPrice`;
            }
        }

        function calculatePrice(event, element) {
            if (event.keyCode === 13 || event.keyCode === 9) {
                element.value = changeComma(element.value);
                let index = getIndex(element.id);
                if (`Sales_${index}__Quantity` == element.id) {
                    let price = document.getElementById(`Sales_${index}__Price`);
                    let tottalPrice = document.getElementById(`Sales_${index}__TottalPrice`);
                    if (price.value != null && price.value !='') {

                        tottalPrice.value = (Number.parseFloat(element.value) * Number.parseFloat(price.value)).toFixed(3);
                        tottalPrice.readOnly = true;
                    }
                }
                else if (`Sales_${index}__Price` == element.id) {
                    let quantity = document.getElementById(`Sales_${index}__Quantity`);
                    let tottalPrice = document.getElementById(`Sales_${index}__TottalPrice`);
                    if (quantity.value != null && quantity.value != '') {

                        tottalPrice.value = (Number.parseFloat(element.value) * Number.parseFloat(quantity.value)).toFixed(3);
                        tottalPrice.readOnly = true;
                    }
                }

            }
        }

        function loadProduct(event , element) {
            if (event.keyCode === 13 || event.keyCode === 9) {

                var value = element.value;

                if (value != null && value != '') {

                    var route = "/@userCompanyData.CompanySlug/@userCompanyData.CompanyObjectSlug/Product/GetProductByNameAjax?name=";

                    var loading = document.getElementById('loading');
                    loading.classList.remove('invisible');
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            let item = JSON.parse(this.responseText);
                            loading.classList.add('invisible');

                            let rowId = getIndex(element.id);
                            let isProduct = document.getElementById(`Sales_${getIndex(rowId)}__IsProduct`);
                            if (item != null && isProduct.checked == true) {

                                if (item.productId != null && item.productId != '') {

                                let productId = document.getElementById(`Sales_${rowId}__ProductId`);
                                productId.value = item.productId;

                                if (item.productType != null && item.productType != '') {
                                    let quantityType = document.getElementById(`Sales_${rowId}__ProductType`);
                                    quantityType.readOnly = true;
                                    quantityType.value = item.productType;

                                }
                                if (item.availableQuantity != null && item.availableQuantity != '') {
                                    let quntity = document.getElementById(`Sales_${rowId}__Quantity`);
                                    quntity.setAttribute('data-availableQuantity', item.availableQuantity);
                                    quntity.setAttribute('placeholder', item.availableQuantity);
                                }

                                if (item.price != null && item.price != '') {
                                    let price = document.getElementById(`Sales_${rowId}__Price`);
                                    price.value = item.price.toFixed(3);
                                    price.readOnly = true;
                                }
                                }


                            }
                            else {
                                let productId = document.getElementById(`Sales_${rowId}__ProductId`);
                                productId.value = 0;

                                let quantityType = document.getElementById(`Sales_${rowId}__ProductType`);
                                quantityType.readOnly = false;

                                let price = document.getElementById(`Sales_${rowId}__Price`);
                                price.readOnly = false;
                                isProduct.checked = false;
                            }
                            }

                    };
                    xhttp.open("GET", `${route}${value}`, true);
                    xhttp.send();
                }
            }
        }

        function loadProductOnChangeIsProduct(element) {

                var value = element.value;

                if (value != null && value != '') {

                    var route = "/@userCompanyData.CompanySlug/@userCompanyData.CompanyObjectSlug/Product/GetProductByNameAjax?name=";

                    var loading = document.getElementById('loading');
                    loading.classList.remove('invisible');
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            let item = JSON.parse(this.responseText);
                            loading.classList.add('invisible');

                            let rowId = getIndex(element.id);
                            let isProduct = document.getElementById(`Sales_${getIndex(rowId)}__IsProduct`);
                            if (item != null && isProduct.checked == true) {

                                if (item.productId != null && item.productId != '') {

                                let productId = document.getElementById(`Sales_${rowId}__ProductId`);
                                productId.value = item.productId;

                                if (item.productType != null && item.productType != '') {
                                    let quantityType = document.getElementById(`Sales_${rowId}__ProductType`);
                                    quantityType.readOnly = true;
                                    quantityType.value = item.productType;

                                }
                                if (item.availableQuantity != null && item.availableQuantity != '') {
                                    let quntity = document.getElementById(`Sales_${rowId}__Quantity`);
                                    quntity.setAttribute('data-availableQuantity', item.availableQuantity);
                                    quntity.setAttribute('placeholder', item.availableQuantity);
                                }

                                if (item.price != null && item.price != '') {
                                    let price = document.getElementById(`Sales_${rowId}__Price`);
                                    price.value = item.price.toFixed(3);
                                    price.readOnly = true;
                                }
                                }


                            }
                            else {
                                let productId = document.getElementById(`Sales_${rowId}__ProductId`);
                                productId.value = 0;

                                let quantityType = document.getElementById(`Sales_${rowId}__ProductType`);
                                quantityType.readOnly = false;

                                let price = document.getElementById(`Sales_${rowId}__Price`);
                                price.readOnly = false;
                                isProduct.checked = false;
                            }
                            }

                    };
                    xhttp.open("GET", `${route}${value}`, true);
                    xhttp.send();
                }

        }

        function changeIsProduct(element) {
            if (element.checked === true) {
                let nameElement = document.getElementById(`Sales_${getIndex(element.id)}__Name`);
                loadProductOnChangeIsProduct(nameElement);
            }
        }

        function findProductAjax(e) {
            if (e.value.length < 2) {
                return;
            }

            let isProduct = document.getElementById(`Sales_${getIndex(e.id)}__IsProduct`).checked;
            if (isProduct === true) {

            var dataList = document.getElementById('productDataList');
            var value = e.value;
            var route = "/@userCompanyData.CompanySlug/@userCompanyData.CompanyObjectSlug/Product/FindProductDataListAjax?name=";
            if (value != '' && !partnerDataListValues.includes(value)) {

            var loading = document.getElementById('loading');
            loading.classList.remove('invisible');
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let result = JSON.parse(this.responseText);
                    dataList.innerHTML = "";
                    loading.classList.add('invisible');
                    partnerDataListValues = [];
                    result.forEach(function (item) {

                        var option = document.createElement('option');
                        option.value = item.name;
                        option.id = item.id;
                        partnerDataListValues.push(item.name);
                        dataList.appendChild(option);

                    });
                }
            };
            xhttp.open("GET", `${route}${value}`, true);
                xhttp.send();
            }
            }


        }

        function addProductElement() {

            let index = document.getElementById('productContainer').childElementCount;

            let product = document.createElement('div');
            product.classList.add('col-12', 'm-0', 'd-flex', 'flex-row', 'productRow');
            product.id = `row${index}`;

            let productId = document.createElement('input');
            productId.setAttribute('type', 'hidden');
            productId.id = `Sales_${index}__ProductId`;
            productId.name = `Sales[${index}].ProductId`;
            productId.classList.add('productId');
            product.appendChild(productId);

            let freeProductId = document.createElement('input');
            freeProductId.setAttribute('type', 'hidden');
            freeProductId.id = `Sales_${index}__FreeProductId`;
            freeProductId.name = `Sales[${index}].FreeProductId`;
            freeProductId.classList.add('freeProductId');
            product.appendChild(freeProductId);


            let productCount = document.createElement('span')
            productCount.classList.add('m-0', 'px-1', 'text-right');
            productCount.style.width='25px';
            productCount.innerHTML = productContainer.childElementCount + 1;
            productCount.classList.add('productCount');
            product.appendChild(productCount);

            let isProduct = document.createElement('input');
            isProduct.setAttribute('type', 'checkbox');
            isProduct.setAttribute('data-val', 'true');
            isProduct.setAttribute('data-val-required', 'Полето е задължително');
            isProduct.classList.add('m-auto', 'px-1', 'text-right', 'isProduct');
            isProduct.style.width = '25px';
            isProduct.id = `Sales_${index}__IsProduct`;
            isProduct.name = `Sales[${index}].IsProduct`;
            isProduct.checked = true;
            isProduct.value = true;
            isProduct.addEventListener('change', function () { changeIsProduct(this) });
            product.appendChild(isProduct);

            let productName = document.createElement('input');
            productName.classList.add('col-6', 'm-0', 'p-0');
            productName.setAttribute('type', 'text');
            productName.setAttribute('data-val', 'true');
            productName.setAttribute('data-val-required', 'Полето е задължително');
            productName.setAttribute('list', 'productDataList');
            productName.id = `Sales_${index}__Name`;
            productName.name = `Sales[${index}].Name`;
            productName.classList.add('productName');
            productName.addEventListener('input', function () { findProductAjax(this) });
            productName.addEventListener('keydown', function () { loadProduct(event, this) });
            product.appendChild(productName);

            let productType = document.createElement('input');
            productType.classList.add('col', 'm-0', 'p-0');
            productType.setAttribute('type', 'text');
            productType.setAttribute('data-val', 'true');
            productType.setAttribute('data-val-required', 'Полето е задължително');
            productType.id = `Sales_${index}__ProductType`;
            productType.name = `Sales[${index}].ProductType`;
            productType.classList.add('productType');
            product.appendChild(productType);


            let productQuantity = document.createElement('input');
            productQuantity.classList.add('col', 'm-0', 'p-0');
            productQuantity.setAttribute('type', 'text');
            productQuantity.setAttribute('data-val', 'true');
            productQuantity.setAttribute('data-val-required', 'Полето е задължително');
            productQuantity.setAttribute('data-val-number', 'Стойноста трябва да е число');
            productQuantity.id = `Sales_${index}__Quantity`;
            productQuantity.name = `Sales[${index}].Quantity`;
            productQuantity.classList.add('productQuantity');
            productQuantity.addEventListener('keydown', function () { calculatePrice(event, this) });
            product.appendChild(productQuantity);

            let productPrice = document.createElement('input');
            productPrice.classList.add('col', 'm-0', 'p-0');
            productPrice.setAttribute('type', 'text');
            productPrice.setAttribute('data-val', 'true');
            productPrice.setAttribute('data-val-required', 'Полето е задължително');
            productPrice.setAttribute('data-val-number', 'Стойноста трябва да е число');
            productPrice.id = `Sales_${index}__Price`;
            productPrice.name = `Sales[${index}].Price`;
            productPrice.classList.add('productPrice');
            productPrice.addEventListener('keydown', function () { calculatePrice(event, this) });
            product.appendChild(productPrice);

            let productTottal = document.createElement('input');
            productTottal.classList.add('col', 'm-0', 'p-0');
            productTottal.setAttribute('type', 'text');
            productTottal.setAttribute('data-val', 'true');
            productTottal.setAttribute('data-val-required', 'Полето е задължително');
            productTottal.setAttribute('data-val-number', 'Стойноста трябва да е число');
            productTottal.id = `Sales_${index}__TottalPrice`;
            productTottal.name = `Sales[${index}].TottalPrice`;
            productTottal.classList.add('productTottalPrice');
            productTottal.addEventListener('keydown', function () { newLine(event, this) });
            product.appendChild(productTottal);

            let productDelete = document.createElement('span')
            productDelete.classList.add( 'm-0', 'px-1', 'close');
            productDelete.innerHTML = 'X';
            productDelete.addEventListener('click', function () { delete_row(this) });
            productDelete.classList.add('productDelete');
            product.appendChild(productDelete);


            document.getElementById('productContainer').appendChild(product);
            productName.focus();
            $("#form1")
                .removeData("validator")
                .removeData("unobtrusiveValidation");

            //Parse the form again
            $.validator
                .unobtrusive
                .parse("#form1");
        }

        function changeComma(value) {
            value = value.replace(',', '.');
            return value;
        }

        function findPartnerAjax() {
            var dataList = document.getElementById('partnersDataList');
            var value = document.getElementById('findPartner').value;
            var route = "/@userCompanyData.CompanySlug/@userCompanyData.CompanyObjectSlug/Partner/FindPartnerDataListAjax?name=";
            if (value != '' && !partnerDataListValues.includes(value)) {

            var loading = document.getElementById('loading');
            loading.classList.remove('invisible');
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let result = JSON.parse(this.responseText);
                    dataList.innerHTML = "";
                    loading.classList.add('invisible');
                    partnerDataListValues = [];
                    result.forEach(function (item) {

                        var option = document.createElement('option');
                        option.value = item.name;
                        option.id = item.id;
                        partnerDataListValues.push(item.name);
                        dataList.appendChild(option);

                    });
                }
            };
            xhttp.open("GET", `${route}${value}`, true);
                xhttp.send();
            }
        }

        function loadPartner(event) {
            if (event.keyCode === 13 || event.keyCode === 9) {
                event.preventDefault();
                var value = document.getElementById('findPartner').value;
                var route = "/@userCompanyData.CompanySlug/@userCompanyData.CompanyObjectSlug/Partner/GetPartnerByNameAjax?name=";

                var loading = document.getElementById('loading');
                loading.classList.remove('invisible');
                var xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        let item = JSON.parse(this.responseText);
                        loading.classList.add('invisible');
                        document.getElementById('partnerId').value = item.id;
                        document.getElementById('partnerHead').innerText = item.name;
                        document.getElementById('partner').innerText = item.name;
                        document.getElementById('eik').innerText = item.eik;
                        document.getElementById('isVatRegister').innerText = item.isVatRegistered == true ? "ДА" : "НЕ";
                        document.getElementById('vat').innerText = item.vatId;
                        document.getElementById('address').innerText = `${item.country}, ${item.city}, ${item.address}`;
                        document.getElementById('mol').innerText = item.mol;
                        document.getElementById('email').innerText = item.email;

                        document.getElementById('partnerDescription').focus();

                    }
                };
                xhttp.open("GET", `${route}${value}`, true);
                xhttp.send();
            }
        }

        function loadPartnerById(value) {

            var route = "/@userCompanyData.CompanySlug/@userCompanyData.CompanyObjectSlug/Partner/GetPartnerByIdAjax?id=";

            var loading = document.getElementById('loading');
            loading.classList.remove('invisible');
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    let item = JSON.parse(this.responseText);
                    loading.classList.add('invisible');
                    document.getElementById('partnerId').value = item.id;
                    document.getElementById('partnerHead').innerText = item.name;
                    document.getElementById('partner').innerText = item.name;
                    document.getElementById('eik').innerText = item.eik;
                    document.getElementById('isVatRegister').innerText = item.isVatRegistered == true ? "ДА":"НЕ";
                    document.getElementById('vat').innerText =item.vatId;
                    document.getElementById('address').innerText = `${item.country }, ${item.city}, ${item.address}`;
                    document.getElementById('mol').innerText = item.mol;
                    document.getElementById('email').innerText = item.email;

                }
            };
            xhttp.open("GET", `${route}${value}`, true);
            xhttp.send();
            }

        function nullCheck(string) {
            if (string == null ) {
                return '';
            }
            return string;
        }

        function preventEnter() {
            $('#productContainer').on('keydown', 'input, select, textarea', function (e) {
                var self = $(this)
                    , form = self.parents('form:eq(0)')
                    , focusable
                    , next
                    , prev
                    ;

                if (e.shiftKey) {
                    if (e.keyCode == 13) {
                        focusable = form.find('input,a,select,button,textarea').filter(':visible');
                        prev = focusable.eq(focusable.index(this) - 1);

                        if (prev.length) {
                            prev.focus();
                        } else {
                            form.submit();
                        }
                    }
                }
                else
                    if (e.keyCode == 13) {
                        focusable = form.find('input,a,select,button,textarea').filter(':visible');
                        next = focusable.eq(focusable.index(this) + 1);
                        if (next.length) {
                            next.focus();
                        } else {
                            form.submit();
                        }
                        return false;
                    }
            });
        }


    </script>
}
